services:
  eve-web:
    build:
      context: .
      dockerfile: ./web/Dockerfile
    container_name: eve-web
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"
      - "traefik.http.routers.eve.rule=Host(`eve.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.eve.entrypoints=websecure"
      - "traefik.http.routers.eve.tls.certresolver=letsencrypt"
    networks:
      - traefik-public
  eve-api:
    build:
      context: ./api
    container_name: eve-api
    restart: unless-stopped
    environment:
      CACHE_DIR: /data
      SCAN_CACHE_TTL: 1800
      ESI_SLEEP: 0.08
      PREWARM_STATUS_SYSTEMS: "Jita,Amarr,Dodixie,Rens,Hek"
      PREWARM_STATUS_FILE: /data/prewarm/last_run.json
      PREWARM_HISTORY_FILE: /data/prewarm/history.jsonl
    volumes:
      - ./api/data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"
      - "traefik.http.routers.eve-api.rule=Host(`eve.${TRAEFIK_DOMAIN}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.eve-api.entrypoints=websecure"
      - "traefik.http.routers.eve-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.eve-api.priority=100"
      - "traefik.http.services.eve-api.loadbalancer.server.port=8000"
    networks:
      - traefik-public
  eve-prewarm:
    build:
      context: ./api
      dockerfile: ./Dockerfile.prewarm
    container_name: eve-prewarm
    restart: unless-stopped
    environment:
      CACHE_DIR: /data
      SCAN_CACHE_TTL: 1800
      ESI_SLEEP: 0.08
      PREWARM_CRON: "*/30 * * * *"
      PREWARM_RUN_ON_START: "1"
      PREWARM_OUTPUT_DIR: /data/prewarm
      PREWARM_STATUS_FILE: /data/prewarm/last_run.json
      PREWARM_HISTORY_FILE: /data/prewarm/history.jsonl
      PREWARM_START_SYSTEMS: "Jita,Amarr,Dodixie,Rens,Hek"
      PREWARM_MAX_JUMPS: 5
      PREWARM_SAMPLE_SIZE: 80
      PREWARM_TYPES_PAGES: 2
      PREWARM_ORDER_PAGES: 3
      PREWARM_HOME_ORDER_PAGES: 5
      PREWARM_LIMIT: 10
      PREWARM_MIN_MARGIN: 5
      PREWARM_MAX_RUNTIME: 45
      PREWARM_BUDGET: 50000000
      PREWARM_RETRY_EMPTY: "1"
      PREWARM_TUNE: "0"
    volumes:
      - ./api/data:/data
    networks:
      - traefik-public

networks:
  traefik-public:
    external: true

services:
  eve-web:
    build:
      context: .
      dockerfile: ./web/Dockerfile
    container_name: eve-web
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"
      - "traefik.http.routers.eve.rule=Host(`eve.${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.eve.entrypoints=websecure"
      - "traefik.http.routers.eve.tls.certresolver=letsencrypt"
    networks:
      - traefik-public
  eve-api:
    build:
      context: ./api
    container_name: eve-api
    restart: unless-stopped
    environment:
      CACHE_DIR: /data
      SCAN_CACHE_TTL: 1800
      ESI_SLEEP: 0.08
      PREWARM_STATUS_SYSTEMS: "Jita,Amarr,Dodixie,Rens,Hek"
      PREWARM_STATUS_FILE: /data/prewarm/last_run.json
      PREWARM_HISTORY_FILE: /data/prewarm/history.jsonl
    volumes:
      - ./api/data:/data
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"
      - "traefik.http.routers.eve-api.rule=Host(`eve.${TRAEFIK_DOMAIN}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.eve-api.entrypoints=websecure"
      - "traefik.http.routers.eve-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.eve-api.priority=100"
      - "traefik.http.services.eve-api.loadbalancer.server.port=8000"
    networks:
      - traefik-public
  eve-prewarm:
    build:
      context: ./api
      dockerfile: ./Dockerfile.prewarm
    container_name: eve-prewarm
    restart: unless-stopped
    environment:
      CACHE_DIR: /data
      SCAN_CACHE_TTL: 1800
      ESI_SLEEP: 0.08
      PREWARM_CRON: "*/30 * * * *"
      PREWARM_RUN_ON_START: "1"
      PREWARM_OUTPUT_DIR: /data/prewarm
      PREWARM_STATUS_FILE: /data/prewarm/last_run.json
      PREWARM_HISTORY_FILE: /data/prewarm/history.jsonl
      PREWARM_START_SYSTEMS: "Jita,Amarr,Dodixie,Rens,Hek"
      PREWARM_MAX_JUMPS: 8
      PREWARM_MIN_SECURITY: 0.1
      PREWARM_SAMPLE_SIZE: 400
      PREWARM_TYPES_PAGES: 0
      PREWARM_ORDER_PAGES: 10
      PREWARM_HOME_ORDER_PAGES: 7
      PREWARM_LIMIT: 30
      PREWARM_MIN_MARGIN: 3
      PREWARM_MAX_RUNTIME: 180
      PREWARM_BUDGET: 1000000000
      PREWARM_TAX_PCT: 2.0
      PREWARM_BROKER_PCT: 3.0
      PREWARM_CARGO_M3: 12000
      PREWARM_MIN_PROFIT_PER_JUMP: 200000
      PREWARM_MIN_RESULTS: 3
      PREWARM_FALLBACK_MAX_JUMPS: 8
      PREWARM_FALLBACK_MIN_SECURITY: 0.1
      PREWARM_RETRY_EMPTY: "1"
      PREWARM_TUNE: "0"
      PREWARM_MODE: "both"
    volumes:
      - ./api/data:/data
    networks:
      - traefik-public

networks:
  traefik-public:
    external: true
